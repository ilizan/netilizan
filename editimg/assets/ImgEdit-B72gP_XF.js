import{bO as N,aS as u,u as y,H as V,t as C,b9 as G,bi as H,v,G as L,aK as x}from"./index-BA7zxLou.js";const O={class:"image-uploader"},U={key:1,class:"preview-container"},A={class:"img-box",style:{position:"relative",width:"600px",height:"300px",border:"1px solid red"}},q=["src"],J=["src"],K={__name:"ImgEdit",setup(j){const f=u(""),h=u(null),w=u(!1);let g=u(!1),a=u([]);const p=u(),I=()=>{h.value.click()},F=e=>{const o=e.target.files[0];if(o){if(!o.type.startsWith("image/")){alert("请选择图片文件！"),b();return}const l=new FileReader;l.onload=s=>{f.value=s.target.result},l.readAsDataURL(o)}},E=()=>{f.value="",b()},b=()=>{h.value&&(h.value.value="")};function S(e){if(!w.value||!g.value)return;const o=e.target,l=o.getBoundingClientRect(),s=e.clientX-l.left,n=e.clientY-l.top,t=o.getContext("2d"),i=T(s,n);if(i!==-1)i===0&&a.value.length>2&&(g.value=!1,P(t,o,!0));else{if(t.fillStyle="#409EFF",t.beginPath(),t.arc(s,n,5,0,Math.PI*2),t.fill(),a.value.length>0){const c=a.value[a.value.length-1];t.strokeStyle="#409EFF",t.lineWidth=3,t.beginPath(),t.moveTo(c.x,c.y),t.lineTo(s,n),t.stroke()}g.value=!0,a.value.push({x:s,y:n})}}function M(e){if(!g.value||a.value.length===0)return;const o=e.target,l=o.getBoundingClientRect(),s=e.clientX-l.left,n=e.clientY-l.top,t=o.getContext("2d"),i=T(s,n);P(t,o,!1,i);const c=a.value[a.value.length-1];t.beginPath(),t.moveTo(c.x,c.y),t.lineTo(s,n),t.stroke()}function P(e,o,l=!1,s=-1){if(e.clearRect(0,0,o.width,o.height),e.fillStyle="#409EFF",e.strokeStyle="#409EFF",e.lineWidth=3,l&&a.value.length>2){e.fillStyle="rgba(255, 255, 255, .6)",e.beginPath(),e.moveTo(a.value[0].x,a.value[0].y);for(let n=1;n<a.value.length;n++)e.lineTo(a.value[n].x,a.value[n].y);e.closePath(),e.fill()}for(let n=0;n<a.value.length;n++){const t=a.value[n],i=n===s?8:5;if(e.beginPath(),e.arc(t.x,t.y,i,0,Math.PI*2),e.fill(),n>0){const c=a.value[n-1];e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(t.x,t.y),e.stroke()}}l&&a.value.length>1&&(e.beginPath(),e.moveTo(a.value[a.value.length-1].x,a.value[a.value.length-1].y),e.lineTo(a.value[0].x,a.value[0].y),e.stroke())}function T(e,o){for(let l=0;l<a.value.length;l++){const s=a.value[l],n=s.x-e,t=s.y-o;if(Math.sqrt(n*n+t*t)<=5)return l}return-1}const _=u(),R=u();async function B(){w.value=!0,a.value=[],g.value=!0}u({});const X=()=>{const e=p.value,o=e.parentElement.getBoundingClientRect(),l=e.getBoundingClientRect(),s=p.value.naturalWidth/l.width,n=p.value.naturalHeight/l.height,t=l.left-o.left,i=l.top-o.top;return{scaleX:s,scaleY:n,offsetX:t,offsetY:i}},Y=e=>new Promise(o=>{const l=new Image;l.crossOrigin="anonymous",l.onload=()=>{const s=Math.min(...e.map(r=>r.x)),n=Math.max(...e.map(r=>r.x)),t=Math.min(...e.map(r=>r.y)),i=Math.max(...e.map(r=>r.y)),c=n-s,k=i-t,m=document.createElement("canvas");m.width=c,m.height=k;const d=m.getContext("2d");d.beginPath(),d.moveTo(e[0].x-s,e[0].y-t),e.forEach((r,D)=>{D>0&&d.lineTo(r.x-s,r.y-t)}),d.closePath(),d.clip(),d.drawImage(l,s,t,c,k,0,0,c,k),o(m)},l.src=f.value});u("");async function W(){const{scaleX:e,scaleY:o,offsetX:l,offsetY:s}=X(),n=a.value.map(i=>({x:(i.x-l)/e,y:(i.y-s)/o}));console.log(n);const t=await Y(n);_.value=t.toDataURL("image/png"),console.log(_.value)}return(e,o)=>(x(),y("div",O,[V(G(H(a))+" ",1),f.value?C("",!0):(x(),y("div",{key:0,class:"upload-area",onClick:I},[v("input",{type:"file",ref_key:"fileInput",ref:h,accept:"image/*",onChange:F,class:"file-input"},null,544),o[0]||(o[0]=L('<div class="upload-hint" data-v-667ffe24><svg class="icon" viewBox="0 0 24 24" width="48" height="48" stroke="currentColor" stroke-width="2" fill="none" data-v-667ffe24><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-667ffe24></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-667ffe24></circle><polyline points="21 15 16 10 5 21" data-v-667ffe24></polyline></svg><p data-v-667ffe24>点击上传图片</p><p class="hint-text" data-v-667ffe24>支持 JPG、PNG、WebP 等格式</p></div>',1))])),f.value?(x(),y("div",U,[v("div",A,[v("img",{src:f.value,alt:"预览图",ref_key:"cropperimage",ref:p,class:"preview-image"},null,8,q),w.value?(x(),y("canvas",{key:0,ref:"drawingcanvas",class:"drawing_canvas",onClick:S,onMousemove:M,width:"600",height:"300"},null,544)):C("",!0)]),v("div",null,[v("button",{type:"button",onClick:B},"钢笔模式"),v("button",{type:"primary",onClick:W},"确认裁剪")]),v("img",{src:_.value,style:{width:"200px"}},null,8,J),v("canvas",{ref_key:"resultCanvas",ref:R},null,512),v("button",{onClick:E,class:"clear-btn"},"清除图片")])):C("",!0)]))}},Q=N(K,[["__scopeId","data-v-667ffe24"]]);export{Q as default};
