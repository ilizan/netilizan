import{bO as Q,aS as c,u as p,H as Z,t as P,b9 as $,bi as j,v as u,G as ee,aK as m}from"./index-BAi-_Ng5.js";const te={class:"image-uploader"},ne={key:1,class:"preview-container"},ae={class:"img-box",style:{position:"relative",width:"600px",height:"300px",border:"1px solid red"}},le=["src"],oe=["src"],ie={__name:"ImgEdit",setup(se){const g=c(""),y=c(null),w=c(!1);let v=c(!1),i=c([]);const _=c(),N=()=>{y.value.click()},U=e=>{const a=e.target.files[0];if(a){if(!a.type.startsWith("image/")){alert("请选择图片文件！"),k();return}const l=new FileReader;l.onload=o=>{g.value=o.target.result},l.readAsDataURL(a)}},A=()=>{g.value="",k()},k=()=>{y.value&&(y.value.value="")};function H(e){if(!w.value||!v.value)return;const a=e.target,l=a.getBoundingClientRect(),o=e.clientX-l.left,t=e.clientY-l.top,n=a.getContext("2d"),r=F(o,t);if(r!==-1)r===0&&i.value.length>2&&(v.value=!1,C(n,a,!0));else{if(n.fillStyle="#409EFF",n.beginPath(),n.arc(o,t,5,0,Math.PI*2),n.fill(),i.value.length>0){const s=i.value[i.value.length-1];n.strokeStyle="#409EFF",n.lineWidth=3,n.beginPath(),n.moveTo(s.x,s.y),n.lineTo(o,t),n.stroke()}v.value=!0,i.value.push({x:o,y:t})}}function L(e){if(!v.value||i.value.length===0)return;const a=e.target,l=a.getBoundingClientRect(),o=e.clientX-l.left,t=e.clientY-l.top,n=a.getContext("2d"),r=F(o,t);C(n,a,!1,r);const s=i.value[i.value.length-1];n.beginPath(),n.moveTo(s.x,s.y),n.lineTo(o,t),n.stroke()}function C(e,a,l=!1,o=-1){if(e.clearRect(0,0,a.width,a.height),e.fillStyle="#409EFF",e.strokeStyle="#409EFF",e.lineWidth=3,l&&i.value.length>2){e.fillStyle="rgba(255, 255, 255, .6)",e.beginPath(),e.moveTo(i.value[0].x,i.value[0].y);for(let t=1;t<i.value.length;t++)e.lineTo(i.value[t].x,i.value[t].y);e.closePath(),e.fill()}for(let t=0;t<i.value.length;t++){const n=i.value[t],r=t===o?8:5;if(e.beginPath(),e.arc(n.x,n.y,r,0,Math.PI*2),e.fill(),t>0){const s=i.value[t-1];e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(n.x,n.y),e.stroke()}}l&&i.value.length>1&&(e.beginPath(),e.moveTo(i.value[i.value.length-1].x,i.value[i.value.length-1].y),e.lineTo(i.value[0].x,i.value[0].y),e.stroke())}function F(e,a){for(let l=0;l<i.value.length;l++){const o=i.value[l],t=o.x-e,n=o.y-a;if(Math.sqrt(t*t+n*n)<=5)return l}return-1}function V(e){if(e.length===0)return{width:0,height:0,x:0,y:0};let a=e[0].x,l=e[0].x,o=e[0].y,t=e[0].y;for(let s of e)s.x<a&&(a=s.x),s.x>l&&(l=s.x),s.y<o&&(o=s.y),s.y>t&&(t=s.y);const n=l-a,r=t-o;return{width:n,height:r,x:a,y:o}}function G(e){return new Promise((a,l)=>{const o=_.value;if(!o||!o.complete){l(new Error("图片未加载完成"));return}const t=document.createElement("canvas");t.width=e.width,t.height=e.height,o.complete&&o.naturalHeight!==0?I(o,t,e,a):(o.onload=()=>I(o,t,e,a),o.onerror=()=>l(new Error("图片加载失败")))})}function I(e,a,l,o){console.log(e,a,l,o);const t=a.getContext("2d"),n=R();console.log(n);const[r,s,f,h,S,E]=n,B=-l.x,X=-l.y,Y=(B*h-f*X)/(r*h-f*s),W=(X*r-s*B)/(r*h-f*s),K=r*Y+f*W+S,z=s*Y+h*W+E,D=e.naturalWidth,M=e.naturalHeight,x=D/2,b=M/2;t.clearRect(0,0,l.width,l.height),t.save(),t.translate(x,b),console.log(x,b),t.transform(r,s,f,h,S,E),console.log(r,s,f,h,K,z),t.translate(-x,-b),t.drawImage(e,0,0,D,M),t.restore(),o(a)}const T=c(),d=c();async function O(){w.value=!0,i.value=[],v.value=!0}c({});const R=()=>[1,0,0,1,0,0];c("");async function q(){const e=V(i.value),a=await G(e);console.log(a),console.log(a.width),d.value.width=a.width,d.value.height=a.height;const l=d.value.getContext("2d"),o=i.value.map(n=>({x:n.x-e.x,y:n.y-e.y}));l.fillStyle="transparent",l.beginPath(),l.moveTo(o[0].x,o[0].y);for(let n=1;n<o.length;n++)l.lineTo(o[n].x,o[n].y);l.closePath(),l.save(),l.clip(),l.drawImage(a,0,0,a.width,a.height);const t=d.value.toDataURL("image/png");T.value=t,J(t,"文件名.png")}function J(e,a){for(var l=e.split(","),o=l[0].match(/:(.*?);/)[1],t=atob(l[1]),n=t.length,r=new Uint8Array(n);n--;)r[n]=t.charCodeAt(n);const s=new Blob([r],{type:o});return new File([s],a,{type:o})}return(e,a)=>(m(),p("div",te,[Z($(j(i))+" ",1),g.value?P("",!0):(m(),p("div",{key:0,class:"upload-area",onClick:N},[u("input",{type:"file",ref_key:"fileInput",ref:y,accept:"image/*",onChange:U,class:"file-input"},null,544),a[0]||(a[0]=ee('<div class="upload-hint" data-v-0ef5a23f><svg class="icon" viewBox="0 0 24 24" width="48" height="48" stroke="currentColor" stroke-width="2" fill="none" data-v-0ef5a23f><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-0ef5a23f></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-0ef5a23f></circle><polyline points="21 15 16 10 5 21" data-v-0ef5a23f></polyline></svg><p data-v-0ef5a23f>点击上传图片</p><p class="hint-text" data-v-0ef5a23f>支持 JPG、PNG、WebP 等格式</p></div>',1))])),g.value?(m(),p("div",ne,[u("div",ae,[u("img",{src:g.value,alt:"预览图",ref_key:"cropperimage",ref:_,class:"preview-image"},null,8,le),w.value?(m(),p("canvas",{key:0,ref:"drawingcanvas",class:"drawing_canvas",onClick:H,onMousemove:L,width:"600",height:"300"},null,544)):P("",!0)]),u("div",null,[u("button",{type:"button",onClick:O},"钢笔模式"),u("button",{type:"primary",onClick:q},"确认裁剪")]),u("img",{src:T.value,style:{width:"200px"}},null,8,oe),u("canvas",{ref_key:"resultCanvas",ref:d},null,512),u("button",{onClick:A,class:"clear-btn"},"清除图片")])):P("",!0)]))}},ce=Q(ie,[["__scopeId","data-v-0ef5a23f"]]);export{ce as default};
